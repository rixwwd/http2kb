name: Cloudflare Pagesへデプロイ

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: minify
        run: |
          npm install html-minifier -g
          mkdir frontend/dist
          npx html-minifier \
            --collapse-whitespace \
            --remove-comments \
            --minify-css true \
            --minify-js true \
            -o frontend/dist/index.html \
            frontend/index.html
          
          npm install clean-css-cli -g
          npx cleancss -o frontend/dist/styles.css frontend/styles.css

      - name: deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{secrets.CLOUDFLARE_API_TOKEN}}
          CLOUDFLARE_ACCOUNT_ID: ${{secrets.CLOUDFLARE_ACCOUNT_ID}}
        run: |
          npm install wrangler -g
          npx wrangler pages deploy dist --project-name http2kb
